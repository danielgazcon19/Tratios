<div class="admin-container">
  <!-- Navegación del panel admin -->
  <div class="admin-nav">
    <a routerLink="/admin/empresas" routerLinkActive="active" class="nav-item">
      <i class="fas fa-building"></i>
      Empresas
    </a>
    <a routerLink="/admin/suscripciones" routerLinkActive="active" class="nav-item">
      <i class="fas fa-file-invoice"></i>
      Suscripciones
    </a>
    <a routerLink="/admin/planes" routerLinkActive="active" class="nav-item">
      <i class="fas fa-tags"></i>
      Planes
    </a>
    <a routerLink="/admin/servicios" routerLinkActive="active" class="nav-item">
      <i class="fas fa-cogs"></i>
      Servicios
    </a>
    <a routerLink="/admin/plan-servicios" routerLinkActive="active" class="nav-item">
      <i class="fas fa-link"></i>
      Asociar Planes
    </a>
    <a routerLink="/admin/soporte" routerLinkActive="active" class="nav-item">
      <i class="fas fa-headset"></i>
      Soporte
    </a>
  </div>

  <div class="header">
    <div>
      <h1>Asociar Servicios a Planes</h1>
      <p class="subtitle">Arrastra y suelta los servicios en los planes para asociarlos</p>
    </div>
    <button class="btn-primary" (click)="recargar()">
      <i class="fas fa-sync-alt"></i>
      Recargar
    </button>
  </div>

  <div *ngIf="cargando" class="loading">
    <i class="fas fa-spinner fa-spin"></i>
    Cargando datos...
  </div>

  <div *ngIf="!cargando" class="drag-drop-container">
    <!-- Panel de Servicios Disponibles -->
    <div class="servicios-panel">
      <div class="panel-header">
        <i class="fas fa-cogs"></i>
        <h3>Servicios Disponibles</h3>
        <span class="badge">{{ serviciosDisponibles.length }}</span>
      </div>
      
      <div 
        cdkDropList
        id="servicios-list"
        [cdkDropListData]="serviciosDisponibles"
        [cdkDropListConnectedTo]="planesListIds"
        class="servicios-list"
        cdkDropListSortingDisabled>
        
        <div 
          *ngFor="let servicio of serviciosDisponibles" 
          class="servicio-item"
          cdkDrag>
          <div class="servicio-content">
            <div class="servicio-icon">
              <i class="fas fa-grip-vertical"></i>
            </div>
            <div class="servicio-info">
              <strong>{{ servicio.nombre }}</strong>
              <small>{{ servicio.descripcion || 'Sin descripción' }}</small>
            </div>
          </div>
          
          <div class="cdk-drag-placeholder" *cdkDragPlaceholder>
            <div class="placeholder-content">
              <i class="fas fa-hand-rock"></i>
              Arrastrando...
            </div>
          </div>
        </div>

        <div *ngIf="serviciosDisponibles.length === 0" class="empty-list">
          <i class="fas fa-check-circle"></i>
          <p>Todos los servicios están asignados</p>
        </div>
      </div>
    </div>

    <!-- Planes Cards -->
    <div class="planes-grid">
      <div *ngFor="let plan of planes" class="plan-card">
        <div class="plan-header">
          <div class="plan-title">
            <i class="fas fa-tag"></i>
            <h3>{{ plan.nombre }}</h3>
          </div>
          <div class="plan-prices">
            <span class="price-mensual">${{ plan.precio_mensual | number: '1.0-0' }}/mes</span>
            <span class="price-anual">${{ plan.precio_anual | number: '1.0-0' }}/año</span>
          </div>
        </div>

        <div class="plan-stats">
          <span class="stat">
            <i class="fas fa-boxes"></i>
            {{ plan.total_servicios }} servicio(s)
          </span>
        </div>

        <div 
          cdkDropList
          [id]="'plan-' + plan.id"
          [cdkDropListData]="plan.servicios"
          [cdkDropListConnectedTo]="['servicios-list']"
          (cdkDropListDropped)="drop($event, plan.id)"
          class="plan-servicios-list">
          
          <div 
            *ngFor="let servicio of plan.servicios" 
            class="servicio-item-small"
            [class.editing]="editandoCantidad?.planId === plan.id && editandoCantidad?.servicioId === servicio.id"
            cdkDrag>
            <div class="servicio-content-small">
              <i class="fas fa-grip-vertical drag-handle"></i>
              <div class="servicio-nombre-cantidad">
                <span class="servicio-nombre">{{ servicio.nombre }}</span>
                
                <!-- Mostrar cantidad cuando NO está editando -->
                <button 
                  *ngIf="!(editandoCantidad?.planId === plan.id && editandoCantidad?.servicioId === servicio.id)"
                  class="btn-cantidad"
                  (click)="editarCantidad(plan, servicio)"
                  [class.has-cantidad]="servicio.cantidad !== null && servicio.cantidad !== undefined"
                  title="Click para editar cantidad">
                  <i class="fas fa-hashtag"></i>
                  <span *ngIf="servicio.cantidad !== null && servicio.cantidad !== undefined">{{ servicio.cantidad }}</span>
                  <span *ngIf="servicio.cantidad === null || servicio.cantidad === undefined">∞</span>
                </button>

                <!-- Input de cantidad cuando ESTÁ editando -->
                <div 
                  *ngIf="editandoCantidad?.planId === plan.id && editandoCantidad?.servicioId === servicio.id"
                  class="cantidad-input-group"
                  @slideIn>
                  <input 
                    type="number" 
                    [(ngModel)]="cantidadTemp"
                    placeholder="Ej: 5"
                    class="cantidad-input"
                    min="0"
                    (keyup.enter)="guardarCantidad(plan, servicio)"
                    (keyup.escape)="cancelarEdicionCantidad()"
                    autofocus>
                  <button 
                    class="btn-save-cantidad" 
                    (click)="guardarCantidad(plan, servicio)"
                    title="Guardar">
                    <i class="fas fa-check"></i>
                  </button>
                  <button 
                    class="btn-cancel-cantidad" 
                    (click)="cancelarEdicionCantidad()"
                    title="Cancelar">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
              <button 
                class="btn-remove" 
                (click)="eliminarServicioDePlan(plan, servicio)"
                title="Eliminar">
                <i class="fas fa-times"></i>
              </button>
            </div>

            <div class="cdk-drag-placeholder" *cdkDragPlaceholder></div>
          </div>

          <div *ngIf="plan.servicios.length === 0" class="empty-plan">
            <i class="fas fa-arrow-left"></i>
            <p>Arrastra servicios aquí</p>
          </div>
        </div>
      </div>

      <div *ngIf="planes.length === 0" class="no-planes">
        <i class="fas fa-tags fa-3x"></i>
        <p>No hay planes creados</p>
        <a routerLink="/admin/planes" class="btn-primary">
          <i class="fas fa-plus"></i>
          Crear Plan
        </a>
      </div>
    </div>
  </div>

  <!-- Instrucciones -->
  <div *ngIf="!cargando && planes.length > 0" class="instrucciones">
    <div class="instruccion-item">
      <i class="fas fa-mouse-pointer"></i>
      <span>Arrastra servicios desde el panel izquierdo hacia los planes</span>
    </div>
    <div class="instruccion-item">
      <i class="fas fa-hashtag"></i>
      <span>Haz clic en el botón <strong>#</strong> para establecer una cantidad límite (usuarios, sedes, etc.)</span>
    </div>
    <div class="instruccion-item">
      <i class="fas fa-times-circle"></i>
      <span>Haz clic en <strong>×</strong> para eliminar un servicio de un plan</span>
    </div>
  </div>
</div>
